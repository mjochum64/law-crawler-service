<?xml version="1.0" encoding="UTF-8" ?>
<!--
 Data Import Handler Konfiguration für Rechtsdokumente
 Importiert XML-Dateien aus dem legal-documents Verzeichnis
-->
<dataConfig>
  
  <!-- ==================== ENTITY: LEGAL DOCUMENTS ==================== -->
  <dataSource name="fileDataSource" type="FileDataSource" />
  
  <document>
    <entity name="legal_document" 
            dataSource="fileDataSource"
            processor="XPathEntityProcessor"
            url="${dih.legal.documents.path}"
            forEach="/html"
            transformer="RegexTransformer,DateFormatTransformer,ScriptTransformer">
      
      <!-- === Basis-Felder === -->
      <!-- ID generieren aus document_id -->
      <field column="id" xpath="/html/head/title" 
             template="legal_${document_id}" />
      
      <!-- Document ID aus URL extrahieren -->
      <field column="document_id" 
             xpath="//span[@class='Z3988']/@title" 
             regex="docid=([A-Z0-9]+)" 
             replaceWith="$1"/>
      
      <field column="source_url" 
             xpath="//span[@class='Z3988']/@title" 
             regex="rft_id=([^&amp;]+)" 
             replaceWith="$1"/>
      
      <!-- === Metadaten aus Tabelle extrahieren === -->
      <field column="court" 
             xpath="//td[strong='Gericht:']/following-sibling::td[1]" />
      
      <field column="court_full_name" 
             xpath="//td[strong='Gericht:']/following-sibling::td[1]" />
      
      <field column="decision_date" 
             xpath="//td[strong='Entscheidungsdatum:']/following-sibling::td[1]" 
             dateTimeFormat="dd.MM.yyyy"/>
      
      <field column="case_number" 
             xpath="//td[strong='Aktenzeichen:']/following-sibling::td[1]" />
      
      <field column="ecli_identifier" 
             xpath="//td[strong='ECLI:']/following-sibling::td[1]" />
      
      <field column="document_type" 
             xpath="//td[strong='Dokumenttyp:']/following-sibling::td[1]" />
      
      <!-- === Titel aus verschiedenen Quellen === -->
      <field column="title" 
             xpath="/html/head/title" />
      
      <!-- === Inhalts-Extraktion === -->
      <!-- Leitsatz -->
      <field column="leitsatz" 
             xpath="//h4[contains(text(),'Leitsatz')]/following-sibling::div//p" 
             commonField="true"/>
      
      <!-- Tenor -->
      <field column="tenor" 
             xpath="//h4[contains(text(),'Tenor')]/following-sibling::div//p" 
             commonField="true"/>
      
      <!-- Gründe -->
      <field column="gruende" 
             xpath="//h4[contains(text(),'Gründe') or contains(text(),'Entscheidungsgründe')]/following-sibling::div//p" 
             commonField="true"/>
      
      <!-- Verfahrensgang -->
      <field column="verfahrensgang" 
             xpath="//h3[contains(text(),'Verfahrensgang')]/following-sibling::div" 
             commonField="true"/>
      
      <!-- Normen aus spezieller Tabellenzelle -->
      <field column="normen" 
             xpath="//td[strong='Normen:']/following-sibling::td[1]" />
      
      <!-- Volltext: Alle Paragraphen im Dokumentbereich -->
      <field column="full_text" 
             xpath="//div[@class='docLayoutText']//p" 
             commonField="true"/>
      
      <!-- Richter aus Unterschriften am Ende -->
      <field column="richter" 
             xpath="//div[@class='docLayoutText']//p[last()]" 
             regex="([A-ZÄÖÜ][a-zäöüß]+)(?:\s+([A-ZÄÖÜ][a-zäöüß]+))*" 
             splitBy="\s+"
             commonField="true"/>
      
      <!-- === Technische Felder === -->
      <!-- Jahr aus Entscheidungsdatum -->
      <field column="year" 
             xpath="//td[strong='Entscheidungsdatum:']/following-sibling::td[1]" 
             regex="([0-9]{4})" 
             replaceWith="$1"/>
      
      <!-- Monat aus Entscheidungsdatum -->
      <field column="month" 
             xpath="//td[strong='Entscheidungsdatum:']/following-sibling::td[1]" 
             regex="[0-9]+\.([0-9]+)\.[0-9]+" 
             replaceWith="$1"/>
      
      <!-- Senat aus Gericht extrahieren -->
      <field column="senat" 
             xpath="//td[strong='Gericht:']/following-sibling::td[1]" 
             regex="([0-9]+\.?\s*[A-Za-z]*\s*[Ss]enat|[0-9]+\.?\s*[Ss]enat)" 
             replaceWith="$1"/>
      
      <!-- File Path als statisches Feld -->
      <field column="file_path" template="${dih.current.file.path}" />
      
      <!-- Crawled At aus File Modification Time -->
      <field column="crawled_at" template="${dih.current.file.lastModified}" />
      
      <!-- Status -->
      <field column="status" template="INDEXED" />
      
      <!-- Indexed At -->
      <field column="indexed_at" template="${dih.functions.formatDate(new Date(),'yyyy-MM-dd\\'T\\'HH:mm:ss\\'Z\\'')}"/>
      
    </entity>
  </document>
  
</dataConfig>